<app-home-bar></app-home-bar>

<div *ngIf="mensajeAlerta" class="alerta" [ngClass]="tipoAlerta">
    {{ mensajeAlerta }}
</div>

<div class="monitor-container">
    <h2>Caratula Evac</h2>

    <div class="acciones-monitor">
        <button class="btn btn-secondary" [routerLink]="['/inicio-caratulas']">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
        <button class="btn btn-secondary" (click)="generarPDF()">
            <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
        <button class="btn btn-secondary" (click)="abrirModalEmail()" [disabled]="!datosCliente">
            <i class="fas fa-envelope"></i> Enviar por Email
        </button>
    </div>

    <!-- Sección de búsqueda mejorada -->
    <div class="search-section">
        <div class="search-container">
            <div class="search-input-group">
                <input type="text" [(ngModel)]="terminoBusqueda" (input)="onInputChange($event)"
                    (focus)="onFocusInput()" (blur)="onBlurInput()" (keydown)="onKeyDown($event)"
                    placeholder="Buscar por clave o nombre del cliente..." class="buscador-input" #searchInput
                    [disabled]="isLoading">

                <button class="btn search-btn" (click)="realizarBusqueda()"
                    [disabled]="isLoading || !terminoBusqueda.trim()">
                    <i class="fas fa-search" *ngIf="!isLoading"></i>
                    <i class="fas fa-spinner fa-spin" *ngIf="isLoading"></i>
                    {{ isLoading ? 'Buscando...' : 'Buscar' }}
                </button>

                <button class="btn clear-btn" (click)="limpiarBusqueda()" *ngIf="terminoBusqueda"
                    title="Limpiar búsqueda">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Dropdown de sugerencias mejorado -->
            <div *ngIf="mostrarSugerencias && sugerenciasFiltradas.length > 0" class="sugerencias-dropdown">
                <div *ngFor="let sugerencia of sugerenciasFiltradas" class="sugerencia-item"
                    (mousedown)="seleccionarSugerencia(sugerencia)">
                    <div class="sugerencia-content">
                        <span class="sugerencia-nombre">{{ sugerencia.razon_social || sugerencia.nombre_cliente
                            }}</span>
                        <span class="sugerencia-clave">({{ sugerencia.clave }})</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensaje de error -->
        <div *ngIf="error" class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            {{ error }}
        </div>

        <!-- Indicador de carga -->
        <div *ngIf="isLoading" class="loading-message">
            <i class="fas fa-spinner fa-spin"></i>
            Cargando información...
        </div>
    </div>

    <div id="pdf-content" #contentToExport>

        <div *ngIf="datosCliente && !isLoading">
            <!-- Header del cliente -->

            <div class="titulo" style="display: flex; align-items: center; gap: 12px;">
                <img src="assets/logo_elite.png" alt="Elite Logo" style="height: 60px;">
                <h1>Avance MY26</h1>
            </div>

            <div class="client-info">
                <div class="info-item">
                    <span class="info-label">Clave</span>
                    <span class="info-value">{{ datosCliente.clave }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Evac</span>
                    <span class="info-value">{{ datosCliente.evac }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nombre Cliente</span>
                    <span class="info-value">{{ datosCliente.nombre_cliente }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nivel</span>
                    <span class="info-value">{{ datosCliente.nivel }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Compra Mínima ANUAL</span>
                    <span class="info-value">{{ datosCliente.compra_minima_anual | currency:'USD':'symbol':'1.2-2'
                        }}</span>
                </div>
            </div>

            <!-- Sección Compromiso BIMESTRAL -->
            <div class="section">
                <h3>a) Compromiso BIMESTRAL</h3>

                <div *ngIf="debeMostrarPeriodo('Jul-Ago')" class="periodo-header">
                    <div class="periodo-title">Periodo - Julio-Agosto</div>
                    <div class="periodo-status">
                        <div class="status-item">
                            <span class="status-label">Estado:</span>
                            <span class="status-value" [class.cerrado]="getEstadoPeriodo('Jul-Ago') === 'Cerrado'"
                                [class.en-curso]="getEstadoPeriodo('Jul-Ago') === 'En curso'">
                                {{ getEstadoPeriodo('Jul-Ago') }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- PERIODO SEPTIEMBRE-OCTUBRE (visible desde septiembre) -->
                <div *ngIf="debeMostrarPeriodo('Sep-Oct')" class="periodo-header">
                    <div class="periodo-title">Periodo - Septiembre-Octubre</div>
                    <div class="periodo-status">
                        <div class="status-item">
                            <span class="status-label">Estado:</span>
                            <span class="status-value" [class.cerrado]="getEstadoPeriodo('Sep-Oct') === 'Cerrado'"
                                [class.en-curso]="getEstadoPeriodo('Sep-Oct') === 'En curso'">
                                {{ getEstadoPeriodo('Sep-Oct') }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- PERIODO NOVIEMBRE-DICIEMBRE (visible desde noviembre) -->
                <div *ngIf="debeMostrarPeriodo('Nov-Dic')" class="periodo-header">
                    <div class="periodo-title">Periodo - Noviembre-Diciembre</div>
                    <div class="periodo-status">
                        <div class="status-item">
                            <span class="status-label">Estado:</span>
                            <span class="status-value" [class.cerrado]="getEstadoPeriodo('Nov-Dic') === 'Cerrado'"
                                [class.en-curso]="getEstadoPeriodo('Nov-Dic') === 'En curso'">
                                {{ getEstadoPeriodo('Nov-Dic') }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tabla de marcas ACUMULADA -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>SCOTT</th>
                                <th>APPAREL, SYNCROS, VITTORIA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Compromiso Acumulado</td>
                                <td>{{ getCompromisoAcumuladoScott() | currency:'USD':'symbol':'1.2-2' }}</td>
                                <td>{{ getCompromisoAcumuladoApparel() | currency:'USD':'symbol':'1.2-2' }}</td>
                            </tr>
                            <tr>
                                <td>Avance Acumulado</td>
                                <td>{{ getAvanceAcumuladoScott() | currency:'USD':'symbol':'1.2-2' }}</td>
                                <td>{{ getAvanceAcumuladoApparel() | currency:'USD':'symbol':'1.2-2' }}</td>
                            </tr>
                            <tr>
                                <td>% Acumulado</td>
                                <td>{{ getPorcentajeAcumuladoScott() }}%</td>
                                <td>{{ getPorcentajeAcumuladoApparel() }}%</td>
                            </tr>
                            <tr>
                                <td>Importe Faltante Acumulado</td>
                                <td>{{ getFaltanteAcumuladoScott() | currency:'USD':'symbol':'1.2-2' }}</td>
                                <td>{{ getFaltanteAcumuladoApparel() | currency:'USD':'symbol':'1.2-2' }}</td>
                            </tr>
                            <tr *ngIf="getSobranteAcumuladoScott() > 0 || getSobranteAcumuladoApparel() > 0">
                                <td>Sobrante Acumulado</td>
                                <td>{{ getSobranteAcumuladoScott() | currency:'USD':'symbol':'1.2-2' }}</td>
                                <td>{{ getSobranteAcumuladoApparel() | currency:'USD':'symbol':'1.2-2' }}</td>
                            </tr>
                            <tr>
                                <td>Estatus Acumulado</td>
                                <td>
                                    <span [class.estado-cumplido]="getFaltanteAcumuladoScott() <= 0"
                                        [class.estado-faltante]="getFaltanteAcumuladoScott() > 0">
                                        {{ getFaltanteAcumuladoScott() <= 0 ? 'Cumplido' : 'Faltante' }} </span>
                                </td>
                                <td>
                                    <span [class.estado-cumplido]="getFaltanteAcumuladoApparel() <= 0"
                                        [class.estado-faltante]="getFaltanteAcumuladoApparel() > 0">
                                        {{ getFaltanteAcumuladoApparel() <= 0 ? 'Cumplido' : 'Faltante' }} </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Compra Mínima INICIAL -->
            <div class="section">
                <h3>b) Compra Mínima INICIAL</h3>
                <div class="compra-minima">
                    <div class="compra-item">
                        <div class="compra-label">Meta</div>
                        <div class="compra-value">{{ datosCliente.compra_minima_inicial |
                            currency:'USD':'symbol':'1.2-2' }}
                        </div>
                    </div>
                    <div class="compra-item">
                        <div class="compra-label">Avance</div>
                        <div class="compra-value">{{ datosCliente.avance_global | currency:'USD':'symbol':'1.2-2' }}
                        </div>
                    </div>
                    <div class="compra-item">
                        <div class="compra-label">Porcentaje</div>
                        <div class="compra-porcentaje">{{ datosCliente.porcentaje_global }}%</div>
                    </div>
                </div>
            </div>

            <!-- Compra Mínima ANUAL -->
            <div class="section">
                <h3>c) Compra Mínima ANUAL</h3>
                <div class="compra-minima">
                    <div class="compra-item">
                        <div class="compra-label">Meta</div>
                        <div class="compra-value">{{ datosCliente.compra_minima_anual | currency:'USD':'symbol':'1.2-2'
                            }}
                        </div>
                    </div>
                    <div class="compra-item">
                        <div class="compra-label">Avance</div>
                        <div class="compra-value">{{ datosCliente.acumulado_anticipado | currency:'USD':'symbol':'1.2-2'
                            }}
                        </div>
                    </div>
                    <div class="compra-item">
                        <div class="compra-label">Porcentaje</div>
                        <div class="compra-porcentaje">{{ datosCliente.porcentaje_anual }}%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <div *ngIf="!datosCliente && !isLoading && terminoBusqueda && !error" class="no-results">
        <i class="fas fa-search"></i>
        <p>No se encontraron resultados para "{{ terminoBusqueda }}"</p>
        <small>Intenta con una clave o el nombre completo del cliente</small>
    </div>
</div>

<!-- Modal para enviar por email -->
<div *ngIf="mostrarModalEmail" class="modal-backdrop">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Enviar Carátula por correo</h3>
            <button class="modal-close" (click)="cerrarModalEmail()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label for="emailDestinatario">Email destinatario:</label>
                <input type="email" id="emailDestinatario" [(ngModel)]="emailDestinatario"
                    placeholder="ejemplo@dominio.com" class="form-input" [disabled]="enviandoEmail">
            </div>

            <div class="form-group">
                <label for="mensajePersonalizado">Mensaje personalizado (opcional):</label>
                <textarea id="mensajePersonalizado" [(ngModel)]="mensajePersonalizado"
                    placeholder="Añade un mensaje personalizado..." class="form-textarea" [disabled]="enviandoEmail"
                    rows="4"></textarea>
            </div>

            <div class="cliente-info-modal">
                <h4>Cliente seleccionado:</h4>
                <p><strong>{{ datosCliente?.nombre_cliente }}</strong> ({{ datosCliente?.clave }})</p>
            </div>

            <div class="remitente-info" *ngIf="configuracionEmail">
                <p><strong>Enviando desde:</strong> {{ configuracionEmail.email_remitente }}</p>
                <p><strong>Usuario:</strong> {{ configuracionEmail.usuario_actual }}</p>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" (click)="cerrarModalEmail()" [disabled]="enviandoEmail">
                Cancelar
            </button>
            <button class="btn btn-secondary" (click)="enviarCaratulaPorEmail()"
                [disabled]="!emailDestinatario || enviandoEmail">
                <span *ngIf="!enviandoEmail">Enviar</span>
                <span *ngIf="enviandoEmail">
                    <i class="fas fa-spinner fa-spin"></i> Enviando...
                </span>
            </button>
        </div>
    </div>
</div>
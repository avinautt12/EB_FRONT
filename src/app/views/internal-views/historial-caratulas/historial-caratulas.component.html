<app-home-bar></app-home-bar>

<div class="monitor-container">
  <h2>Historial de CarÃ¡tulas Enviadas</h2>

  <div class="acciones-monitor">
    <button class="btn btn-secondary" [routerLink]="['/inicio-caratulas']">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
    <button class="btn btn-secondary" (click)="exportarAExcel()" [disabled]="historialFiltrado.length === 0">
      <i class="fas fa-file-excel"></i> Exportar a Excel
    </button>
  </div>

  <div *ngIf="isLoading" class="cargando-spinner">
    <div class="spinner"></div>
    <p>Cargando historial...</p>
  </div>

  <div *ngIf="error && !isLoading" class="error-message">
    {{ error }}
    <button (click)="cargarHistorial()" class="btn-reintentar">ðŸ”„ Reintentar</button>
  </div>

  <div *ngIf="!isLoading && !error" class="contenido-principal">
    
    <div class="tabla-controls">
      <button *ngIf="tieneFiltrosActivos" (click)="limpiarTodosFiltros()" class="btn btn-secondary">
        <i class="fas fa-times"></i> Limpiar todos los filtros
      </button>
    </div>

    <div class="tabla-contenedor">
      <div class="tabla-scroll-horizontal">
        <table class="tabla-facturas">
          <thead>
            <tr>
              <th style="width: 200px;">
                <div class="th-content">
                  <span>Nombre Evac</span>
                  <app-filtro filtroId="evac" [options]="nombreEvacOptions"
                    [(showDropdown)]="showNombreEvacFilter" (apply)="onFiltroNombreEvacChange($event)"
                    (clear)="onFiltroNombreEvacChange([])">
                  </app-filtro>
                </div>
              </th>
              <th style="width: 200px;">
                <div class="th-content">
                  <span>Usuario Evac</span>
                  <app-filtro filtroId="usuarios" [options]="usuariosOptions"
                    [(showDropdown)]="showUsuarioFilter" (apply)="onFiltroUsuarioChange($event)"
                    (clear)="onFiltroUsuarioChange([])">
                  </app-filtro>
                </div>
              </th>
              <th style="width: 280px;">
                <div class="th-content">
                  <span>Distribuidor</span>
                  <app-filtro filtroId="clientes" [options]="clientesOptions"
                    [(showDropdown)]="showClienteFilter" (apply)="onFiltroClienteChange($event)"
                    (clear)="onFiltroClienteChange([])">
                  </app-filtro>
                </div>
              </th>
              <th style="width: 180px;">
                <div class="th-content">
                  <span>Clave Distribuidor</span>
                </div>
              </th>
              <th style="width: 250px;">
                <div class="th-content">
                  <span>Correo Remitente</span>
                </div>
              </th>
              <th style="width: 250px;">
                <div class="th-content">
                  <span>Correo Destinatario</span>
                  <app-filtro filtroId="correos" [options]="correosOptions"
                    [(showDropdown)]="showCorreoFilter" (apply)="onFiltroCorreoChange($event)"
                    (clear)="onFiltroCorreoChange([])">
                  </app-filtro>
                </div>
              </th>
              <th style="width: 200px;">
                <div class="th-content">
                  <span>Fecha de EnvÃ­o</span>
                  <app-filtro-fecha filtroId="fecha" (apply)="aplicarFiltroFecha($event)"
                    (clear)="limpiarFiltroFecha()">
                  </app-filtro-fecha>
                </div>
              </th>
              <th style="width: 150px;">
                <div class="th-content">
                  <span>Hora de EnvÃ­o</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historialPaginado">
              <td>{{ item.nombre_usuario }}</td>
              <td>{{ item.usuario_envio }}</td>
              <td>{{ item.cliente_nombre }}</td>
              <td>{{ item.clave_cliente }}</td>
              <td>{{ item.correo_remitente }}</td>
              <td>{{ item.correo_destinatario }}</td>
              <td>{{ formatearFecha(item.fecha_envio) }}</td>
              <td>{{ formatearHora(item.hora_envio) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="historialFiltrado.length === 0" class="sin-datos">
        No se encontraron registros que coincidan con los filtros aplicados.
      </div>
    </div>

    <div *ngIf="historialFiltrado.length > 0" class="paginacion-container">
      <div class="paginador-info">
        <span>Mostrando {{ historialPaginado.length }} de {{ historialFiltrado.length }} registros</span>
      </div>
      <div class="paginador-controles">
        <button (click)="cambiarPagina(1)" [disabled]="paginaActual === 1" class="btn-paginacion">
          <i class="fas fa-angle-double-left"></i> Primera
        </button>
        <button (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1" class="btn-paginacion">
          <i class="fas fa-angle-left"></i> Anterior
        </button>
        <span class="pagina-info">PÃ¡gina {{ paginaActual }}</span>
        <button (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas" class="btn-paginacion">
          Siguiente <i class="fas fa-angle-right"></i>
        </button>
        <button (click)="cambiarPagina(totalPaginas)" [disabled]="paginaActual === totalPaginas" class="btn-paginacion">
          Ãšltima <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>
<app-home-bar></app-home-bar>

<div class="monitor-container">
  <h2>Monitor Previo de Facturas</h2>

  <div class="acciones-monitor">
    <button class="btn" [routerLink]="['/monitor']"><i class="fas fa-folder-open"></i> Monitor</button>
    <button class="btn" [routerLink]="['/multimarcas']"><i class="fas fa-globe"></i> Multimarcas</button>
    <button class="btn" [routerLink]="['/distribuidores']"><i class="fas fa-file-alt"></i> Distribuidores</button>
    <button class="btn" [routerLink]="['/metas']"><i class="fas fa-bullseye"></i> Metas</button>
    <button class="btn" [routerLink]="['/caratulas']"><i class="fas fa-book"></i> Carátulas</button>
    <button class="btn btn-export" (click)="exportarAExcel()" [disabled]="cargando">
      <i class="fas fa-file-excel"></i> Exportar Excel
    </button>
  </div>

  <div *ngIf="cargando" class="cargando-spinner">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>

  <div *ngIf="!cargando && clientesPaginados.length === 0 && integrales.length === 0" class="sin-datos">
    <p>No se pudieron cargar los datos o no hay clientes disponibles.</p>
  </div>

  <div class="tabla-contenedor" *ngIf="!cargando && (clientesPaginados.length > 0 || integrales.length > 0)">
    <table class="tabla-previo" [class.single-row]="clientesFiltrados.length === 1">
      <thead>
        <tr>
          <th class="columna-clave" style="min-width: 120px">
            <div class="filter-horizontal-container">
              <span class="filter-label">Clave</span>
              <app-filtro-previo tipo="clave" placeholder="Buscar clave..." [opciones]="opcionesClave"
                [estaActivo]="esFiltroActivo('clave')" (aplicarFiltro)="aplicarFiltroClave($event)"
                (limpiarFiltro)="limpiarFiltroClave()" (filtroClicked)="toggleFiltro('clave')">
              </app-filtro-previo>
            </div>
          </th>

          <th style="min-width: 150px;">
            <div class="filter-horizontal-container">
              <span class="filter-label">EVAC</span>
              <app-filtro-previo tipo="evac" placeholder="Buscar EVAC..." [opciones]="opcionesEvac"
                [estaActivo]="esFiltroActivo('evac')" (aplicarFiltro)="aplicarFiltroEvac($event)"
                (limpiarFiltro)="limpiarFiltroEvac()" (filtroClicked)="toggleFiltro('evac')">
              </app-filtro-previo>
            </div>
          </th>

          <th style="min-width: 280px;">
            <div class="filter-horizontal-container">
              <span class="filter-label">Cliente</span>
              <app-filtro-previo tipo="cliente" placeholder="Buscar cliente..." [opciones]="opcionesCliente"
                [estaActivo]="esFiltroActivo('cliente')" (aplicarFiltro)="aplicarFiltroCliente($event)"
                (limpiarFiltro)="limpiarFiltroCliente()" (filtroClicked)="toggleFiltro('cliente')">
              </app-filtro-previo>
            </div>
          </th>

          <th style="min-width: 140px;">Acumulado Compra Anticipada</th>

          <th style="min-width: 140px;">
            <div class="filter-horizontal-container">
              <span class="filter-label">Elección NIVEL</span>
              <app-filtro-previo tipo="nivel" placeholder="Buscar nivel..." [opciones]="opcionesEleccionNivel"
                [estaActivo]="esFiltroActivo('nivel')" (aplicarFiltro)="aplicarFiltroEleccionNivel($event)"
                (limpiarFiltro)="limpiarFiltroEleccionNivel()" (filtroClicked)="toggleFiltro('nivel')">
              </app-filtro-previo>
            </div>
          </th>
          <th style="min-width: 110px;">Nivel Cierre Compra Inicial</th>
          <th style="min-width: 120px;">Compra Mínima ANUAL</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 120px;">Compra Mínima INICIAL</th>
          <th style="min-width: 80px;">Avance GLOBAL</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 120px;">Compromiso SCOTT</th>
          <th style="min-width: 120px;">Avance GLOBAL SCOTT</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">Compromiso JUL-AGO</th>
          <th style="min-width: 100px;">Avance</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">Compromiso SEPT-OCT</th>
          <th style="min-width: 120px;">Avance</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">Compromiso NOV-DIC</th>
          <th style="min-width: 120px;">Avance</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 120px;">Compromiso APPAREL, SYNCROS, VITTORIA</th>
          <th style="min-width: 120px;">Avance GLOBAL</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">Compromiso JUL-AGO</th>
          <th style="min-width: 120px;">Avance</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">Compromiso SEPT-OCT</th>
          <th style="min-width: 120px;">Avance</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">Compromiso NOV-DIC</th>
          <th style="min-width: 120px;">Avance</th>
          <th style="min-width: 80px;">%</th>
          <th style="min-width: 100px;">SYNCROS Acumulado</th>
          <th style="min-width: 120px;">APPAREL Acumulado</th>
          <th style="min-width: 120px;">VITTORIA Acumulado</th>
          <th style="min-width: 120px;">BOLD Acumulado</th>
        </tr>
      </thead>
      <tbody>
        <!-- Clientes normales -->
        <tr *ngFor="let cliente of clientesPaginados">
          <td>{{ cliente.clave }}</td>
          <td>{{ cliente.evac }}</td>
          <td>{{ cliente.nombre_cliente }}</td>
          <td>{{ cliente.acumulado_anticipado | currency:'USD':'symbol':'1.2-2' }}</td>
          <td>{{ cliente.nivel }}</td>
          <td></td>
          <td>{{ cliente.compra_minima_anual | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>
            {{
            (
            (cliente?.avance_global_scott || 0) +
            (cliente?.acumulado_syncros || 0) +
            (cliente?.acumulado_apparel || 0) +
            (cliente?.acumulado_vittoria || 0)
            ) / (cliente?.compra_minima_anual || 1)
            | percent:'1.0-0'
            }}
          </td>
          <td>{{ cliente.compra_minima_inicial | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_global_scott || 0) + (cliente.acumulado_syncros || 0) + (cliente.acumulado_apparel ||
            0) + (cliente.acumulado_vittoria || 0) | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>
            {{
            (
            (cliente.avance_global_scott || 0) +
            (cliente.acumulado_syncros || 0) +
            (cliente.acumulado_apparel || 0) +
            (cliente.acumulado_vittoria || 0)
            ) / (cliente.compra_minima_inicial || 1)
            | percent:'1.0-0' }}
          </td>
          <td>{{ cliente.compromiso_scott | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_global_scott | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_global_scott || 0) / (cliente.compromiso_scott || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.compromiso_jul_ago | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_jul_ago | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_jul_ago || 0) / (cliente.compromiso_jul_ago || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.compromiso_sep_oct | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_sep_oct | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_sep_oct || 0) / (cliente.compromiso_sep_oct || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.compromiso_nov_dic | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_nov_dic | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_nov_dic || 0) / (cliente.compromiso_nov_dic || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.compromiso_apparel_syncros_vittoria | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.acumulado_syncros || 0) + (cliente.acumulado_apparel || 0) + (cliente.acumulado_vittoria || 0)
            | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>
            {{
            (
            (cliente.acumulado_syncros || 0) +
            (cliente.acumulado_apparel || 0) +
            (cliente.acumulado_vittoria || 0)
            ) / (cliente.compromiso_apparel_syncros_vittoria || 1)
            | percent:'1.0-0' }}
          </td>
          <td>{{ cliente.compromiso_jul_ago_app | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_jul_ago_app | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_jul_ago_app || 0) / (cliente.compromiso_jul_ago_app || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.compromiso_sep_oct_app | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_sep_oct_app | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_sep_oct_app || 0) / (cliente.compromiso_sep_oct_app || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.compromiso_nov_dic_app | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.avance_nov_dic_app | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ (cliente.avance_nov_dic_app || 0) / (cliente.compromiso_nov_dic_app || 1) | percent:'1.0-0' }}</td>
          <td>{{ cliente.acumulado_syncros | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.acumulado_apparel | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.acumulado_vittoria | currency:'USD':'symbol':'1.0-0' }}</td>
          <td>{{ cliente.acumulado_bold | currency:'USD':'symbol':'1.0-0' }}</td>
        </tr>

        <div *ngIf="mostrarIntegrales">
          <!-- Separador visual para integrales -->
          <tr *ngIf="integrales.length > 0" class="separador-integral">
            <td colspan="39">INTEGRALES</td>
          </tr>

          <!-- Integrales -->
          <tr *ngFor="let integral of integrales" class="fila-integral">
            <td>{{ integral.clave }}</td>
            <td>{{ integral.evac }}</td>
            <td>{{ integral.nombre_cliente }}</td>
            <td>{{ integral.acumulado_anticipado | currency:'USD':'symbol':'1.2-2' }}</td>
            <td>{{ integral.nivel }}</td>
            <td></td>
            <td>{{ integral.compra_minima_anual | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ calculoPorcentajeCompraAnual(integral) }}</td>
            <td>{{ integral.compra_minima_inicial | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_global_scott || 0) + (integral.acumulado_syncros || 0) + (integral.acumulado_apparel
              || 0) + (integral.acumulado_vittoria || 0) | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ calculoPorcentajeCompraInicial(integral) }}</td>
            <td>{{ integral.compromiso_scott | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_global_scott | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_global_scott || 0) / (integral.compromiso_scott || 1) | percent:'1.0-0' }}</td>
            <td>{{ integral.compromiso_jul_ago| currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_jul_ago | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_jul_ago || 0) / (integral.compromiso_jul_ago || 1) | percent:'1.0-0' }}</td>
            <td>{{ integral.compromiso_sep_oct | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_sep_oct | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_sep_oct || 0) / (integral.compromiso_sep_oct || 1) | percent:'1.0-0' }}</td>
            <td>{{ integral.compromiso_nov_dic | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_nov_dic | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_nov_dic || 0) / (integral.compromiso_nov_dic || 1) | percent:'1.0-0' }}
            <td>{{ integral.compromiso_apparel_syncros_vittoria | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.acumulado_syncros || 0) + (integral.acumulado_apparel || 0) + (integral.acumulado_vittoria
              ||
              0) | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ calculoPorcentajeAvanceSynAppVit(integral) }}</td>
            <td>{{ integral.compromiso_jul_ago_app | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_jul_ago_app | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_jul_ago_app || 0) / (integral.compromiso_jul_ago_app || 1) | percent:'1.0-0' }}</td>
            <td>{{ integral.compromiso_sep_oct_app | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_sep_oct_app | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_sep_oct_app || 0) / (integral.compromiso_sep_oct_app || 1) | percent:'1.0-0' }}</td>
            <td>{{ integral.compromiso_nov_dic_app | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.avance_nov_dic_app | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ (integral.avance_nov_dic_app || 0) / (integral.compromiso_nov_dic_app || 1) | percent:'1.0-0' }}</td>
            <td>{{ integral.acumulado_syncros | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.acumulado_apparel | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.acumulado_vittoria | currency:'USD':'symbol':'1.0-0' }}</td>
            <td>{{ integral.acumulado_bold | currency:'USD':'symbol':'1.0-0' }}</td>
          </tr>
        </div>
      </tbody>
    </table>
  </div>

  <div class="paginador" *ngIf="totalPaginas > 1">
    <button (click)="cambiarPagina(1)" [disabled]="paginaActual === 1">« Primera</button>
    <button (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1">‹ Anterior</button>
    <span class="paginador-info">
      Página
      <input type="number" min="1" [max]="totalPaginas" [(ngModel)]="paginaActualTemp"
        (keyup.enter)="cambiarPagina(paginaActualTemp)" />
      de {{ totalPaginas }}
    </span>
    <button (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas">Siguiente ›</button>
    <button (click)="cambiarPagina(totalPaginas)" [disabled]="paginaActual === totalPaginas">Última »</button>
  </div>
</div>
<app-home-bar></app-home-bar>

<div class="monitor-container">
  <h2>Monitor de Facturas</h2>

  <div class="acciones-monitor">
    <button><i class="fas fa-file-import"></i> Importar</button>
    <button><i class="fas fa-file-export"></i> Exportar</button>
    <button><i class="fas fa-folder-open"></i> Caratulas</button>
    <button><i class="fas fa-file-alt"></i> Reportes</button>
    <button><i class="fas fa-chart-bar"></i> Gráficas</button>
  </div>

  <div *ngIf="cargando" class="cargando-spinner">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>

  <div *ngIf="!cargando && facturasPaginadas.length === 0" class="sin-datos">
    <p>No se pudieron cargar los datos o no hay facturas disponibles.</p>
  </div>

  <div *ngIf="!cargando" class="tabla-contenedor">
    <table class="tabla-facturas">
      <thead>
        <tr>
          <th class="columna-numero">
            Número de Factura
            <div class="filtro-columna">
              <button (click)="toggleFiltro('numero_factura')"></button>
              <div class="dropdown-filtro" *ngIf="filtroAbierto === 'numero_factura'">
                <input type="text" [(ngModel)]="filtros.numero_factura" (input)="filtrarFacturas()"
                  placeholder="Filtrar por número..." />
              </div>
            </div>
          </th>
          <th class="columna-referencia">
            Referencia Interna
            <div class="filtro-columna">
              <button (click)="toggleFiltro('referencia_interna')"></button>
              <div class="dropdown-filtro" *ngIf="filtroAbierto === 'referencia_interna'">
                <input type="text" [(ngModel)]="filtros.referencia_interna" (input)="filtrarFacturas()"
                  placeholder="Filtrar por referencia..." />
              </div>
            </div>
          </th>
          <th class="columna-producto">
            Producto
            <div class="filtro-columna">
              <button (click)="toggleFiltro('nombre_producto')"></button>
              <div class="dropdown-filtro" *ngIf="filtroAbierto === 'nombre_producto'">
                <input type="text" [(ngModel)]="filtros.nombre_producto" (input)="filtrarFacturas()"
                  placeholder="Filtrar por producto..." />
              </div>
            </div>
          </th>
          <th class="columna-contacto-ref">
            Ref. Contacto
            <div class="filtro-columna">
              <button (click)="toggleFiltro('contacto_referencia')"></button>
              <div class="dropdown-filtro" *ngIf="filtroAbierto === 'contacto_referencia'">
                <input type="text" [(ngModel)]="filtros.contacto_referencia" (input)="filtrarFacturas()"
                  placeholder="Filtrar por ref. contacto..." />
              </div>
            </div>
          </th>

          <th class="columna-contacto-nom">
            Nombre Contacto
            <div class="filtro-columna">
              <button (click)="toggleFiltro('contacto_nombre')"></button>
              <div class="dropdown-filtro" *ngIf="filtroAbierto === 'contacto_nombre'">
                <input type="text" [(ngModel)]="filtros.contacto_nombre" (input)="filtrarFacturas()"
                  placeholder="Filtrar por nombre contacto..." />
              </div>
            </div>
          </th>
          <th class="columna-fecha">
            Fecha
            <div class="compact-date-filter">
              <!-- Botón combinado para ordenación y filtro -->
              <button class="compact-date-btn" (click)="toggleFechaFilter()">
                <span class="sort-icon">{{ordenFechaAscendente ? '↑' : '↓'}}</span>
                <span class="filter-icon">⏷</span>
              </button>

              <!-- Panel de filtro flotante -->
              <div class="compact-date-panel" *ngIf="filtroFechaAbierto">
                <div class="date-range-controls">
                  <div class="date-input-group">
                    <label>Desde:</label>
                    <input type="date" [(ngModel)]="filtros.fecha_desde" (change)="aplicarFiltroFecha()"
                      class="compact-date-input">
                  </div>
                  <div class="date-input-group">
                    <label>Hasta:</label>
                    <input type="date" [(ngModel)]="filtros.fecha_hasta" (change)="aplicarFiltroFecha()"
                      class="compact-date-input">
                  </div>
                </div>
                <div class="date-sort-controls">
                  <button (click)="cambiarOrdenFecha('asc')" [class.active]="ordenFechaAscendente">↑ Ascendente</button>
                  <button (click)="cambiarOrdenFecha('desc')" [class.active]="!ordenFechaAscendente">↓
                    Descendente</button>
                </div>
              </div>
            </div>
          </th>
          <th class="columna-precio">Precio Unitario</th>
          <th class="columna-cantidad">Cantidad</th>
          <th class="columna-venta-total">Venta Total</th>
          <th class="columna-marca">Marca</th>
          <th class="columna-subcategoria">Subcategoría</th>
          <th class="columna-eride">ERIDE</th>
          <th class="columna-apparel">APPAREL</th>
          <th class="columna-categoria">
            Categoría
            <div class="compact-dropdown">
              <button class="compact-dropdown-btn" (click)="toggleFiltroCategoria()">
                <span class="filter-icon">⏷</span>
              </button>
              <div class="compact-dropdown-panel" *ngIf="filtroCategoriaAbierto">
                <div class="dropdown-actions">
                  <button (click)="seleccionarTodasCategorias()">Seleccionar todo</button>
                  <button (click)="borrarSeleccionCategorias()">Borrar</button>
                </div>
                <input type="text" [(ngModel)]="busquedaCategoria" placeholder="Buscar..." class="dropdown-search" />
                <div class="dropdown-opciones">
                  <label *ngFor="let categoria of categoriasUnicas | filtroPorTexto: busquedaCategoria">
                    <input type="checkbox" [checked]="filtrosCheckbox.categoriasSeleccionadas.has(categoria)"
                      (change)="toggleCategoria(categoria, $event)" />
                    {{ categoria }}
                  </label>
                </div>
              </div>
            </div>
          </th>
          <th class="columna-estado">
            Estado
            <div class="compact-filter-container">
              <button class="compact-filter-btn" (click)="toggleFiltro('estado')"><span
                  class="filter-icon">⏷</span></button>
              <div class="compact-filter-panel" *ngIf="filtroAbierto === 'estado'">
                <div class="checkbox-group">
                  <label *ngFor="let estado of estadosUnicos">
                    <input type="checkbox" [checked]="filtrosCheckbox.estadosSeleccionados.has(estado)"
                      (change)="toggleEstado(estado, $event)" />
                    {{ estado }}
                  </label>
                </div>
              </div>
            </div>
          </th>
          <th class="columna-costo">Costo</th>
        </tr>
      </thead>
      <tbody class="cuerpo-con-scroll">
        <tr *ngFor="let factura of facturasPaginadas">
          <td>{{ factura.numero_factura }}</td>
          <td>{{ factura.referencia_interna }}</td>
          <td>{{ factura.nombre_producto }}</td>
          <td>{{ factura.contacto_referencia }}</td>
          <td>{{ factura.contacto_nombre }}</td>
          <td>{{ factura.fecha_factura | date: 'dd/MM/yyyy' }}</td>
          <td>${{ factura.precio_unitario }}</td>
          <td>{{ factura.cantidad }}</td>
          <td>
            {{
            calcularVentaTotal(factura.precio_unitario, factura.cantidad, factura.estado_factura)
            | currency:'USD':'symbol'
            }}
          </td>
          <td>{{ extraerPrimeraParte(factura.categoria_producto) }}</td>
          <td>{{ obtenerSegundaParte(factura.categoria_producto) }}</td>
          <td>{{ contieneERIDE(factura.categoria_producto) }}</td>
          <td>{{ contieneAPPAREL(factura.categoria_producto) }}</td>
          <td>{{ factura.categoria_producto }}</td>
          <td>{{ factura.estado_factura }}</td>
          <td>${{ factura.costo_producto }}</td>
        </tr>
      </tbody>
    </table>

    <div class="paginador">
      <button (click)="cambiarPagina(1)" [disabled]="paginaActual === 1">« Primera</button>
      <button (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1">‹ Anterior</button>
      <span class="paginador-info">
        Página
        <input type="number" min="1" [max]="totalPaginas" [(ngModel)]="paginaActualTemp"
          (keyup.enter)="cambiarPagina(paginaActualTemp)" />
        de {{ totalPaginas }}
      </span>
      <button (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas">Siguiente ›</button>
      <button (click)="cambiarPagina(totalPaginas)" [disabled]="paginaActual === totalPaginas">Última »</button>
    </div>
  </div>
</div>
<app-home-bar></app-home-bar>

<app-alerta *ngIf="mensajeAlerta" [mensaje]="mensajeAlerta" [tipo]="tipoAlerta"></app-alerta>

<div class="monitor-container">
  <h2>Monitor de Facturas</h2>

  <!-- Barra de acciones -->
  <div class="acciones-monitor">
    <button [routerLink]="['/previo']">
      <i class="fas fa-arrow-left"></i> Previo
    </button>

    <button (click)="seleccionarArchivo()">
      <i class="fas fa-file-import"></i> Importar
    </button>
    <input #inputArchivo type="file" (change)="importarArchivo($event)" hidden accept=".xlsx,.xls" />

    <button (click)="abrirDialogoExportar()">
      <i class="fas fa-file-export"></i> Exportar
    </button>
  </div>

  <!-- Diálogo exportar -->
  <dialog #dialogoExportar class="dialogo-exportar">
    <h3>Selecciona columnas a exportar</h3>

    <div class="columnas-exportar">
      <div *ngFor="let col of columnasDisponibles" class="columna-exportar">
        <label>
          <input type="checkbox" [(ngModel)]="col.seleccionado" />
          {{ col.etiqueta }}
        </label>
      </div>
    </div>

    <div class="botones-dialogo">
      <button class="boton-exportar" (click)="exportarExcel()">Exportar</button>
      <button class="boton-cancelar" (click)="cerrarDialogoExportar()">Cancelar</button>
    </div>
  </dialog>

  <!-- Spinner carga -->
  <div *ngIf="cargando" class="cargando-spinner">
    <div class="spinner"></div>
    <p>Cargando datos...</p>
  </div>

  <!-- Mensaje sin datos -->
  <div *ngIf="!cargando && facturasPaginadas.length === 0" class="sin-datos">
    <p>No se encontraron facturas con los filtros aplicados.</p>
  </div>

  <!-- Tabla facturas -->
  <div *ngIf="!cargando && facturasPaginadas.length > 0" class="tabla-contenedor">
    <table class="tabla-facturas">
      <thead>
        <tr>

          <th class="columna-numero" style="min-width: 140px;">
            Número Factura
            <app-filtro filtroId="numero" [options]="numeroOptions" [(showDropdown)]="showNumeroFilter"
              (apply)="onNumeroFilterApply($event)" (clear)="onNumeroFilterClear()">
            </app-filtro>
          </th>

          <th class="columna-referencia" style="min-width: 140px;">
            Referencia
            <app-filtro filtroId="referencia" [options]="referenciaOptions" [(showDropdown)]="showReferenciaFilter"
              (apply)="onReferenciaFilterApply($event)" (clear)="onReferenciaFilterClear()"></app-filtro>
          </th>

          <th class="columna-producto" style="min-width: 200px;">
            Producto
            <app-filtro filtroId="producto" [options]="productoOptions" [(showDropdown)]="showProductoFilter"
              (apply)="onProductoFilterApply($event)" (clear)="onProductoFilterClear()"></app-filtro>
          </th>

          <th class="columna-contacto-ref">
            Ref. Contacto
            <app-filtro filtroId="contactoReferencia" [options]="contactoReferenciaOptions" [(showDropdown)]="showContactoReferenciaFilter"
              (apply)="onContactoReferenciaFilterApply($event)"
              (clear)="onContactoReferenciaFilterClear()"></app-filtro>
          </th>

          <th class="columna-contacto-nom" style="min-width: 180px;">
            Nombre Contacto
            <app-filtro filtroId="contactoNombre" [options]="contactoNombreOptions" [(showDropdown)]="showContactoNombreFilter"
              (apply)="onContactoNombreFilterApply($event)" (clear)="onContactoNombreFilterClear()"></app-filtro>
          </th>

          <th class="columna-fecha" style="min-width: 100px;">
            Fecha
            <app-filtro-fecha filtroId="fecha" [(showDropdown)]="showFechaFilter" (apply)="onFechaFilterApply($event)"
              (clear)="onFechaFilterClear()">
            </app-filtro-fecha>
          </th>

          <!-- Columnas sin filtro de texto -->
          <th style="min-width: 120px;">Precio Unit.</th>
          <th class="columna-cantidad">Cantidad</th>
          <th style="min-width: 120px;">Total</th>

          <!-- Filtros con checkbox (ejemplo Marca) -->
          <th class="columna-marca" style="min-width: 120px;">
            Marca
            <app-filtro filtroId="marca" [options]="marcaOptions" [(showDropdown)]="showMarcaFilter" (apply)="onMarcaFilterApply($event)"
              (clear)="onMarcaFilterClear()"></app-filtro>
          </th>

          <!-- Más columnas con filtros checkbox similar a Marca -->
          <th class="columna-subcategoria" style="min-width: 120px;">
            Subcategoría
            <app-filtro filtroId="subcategoria" [options]="subcategoriaOptions" [(showDropdown)]="showSubcategoriaFilter"
              (apply)="onSubcategoriaFilterApply($event)" (clear)="onSubcategoriaFilterClear()"></app-filtro>
          </th>

          <th class="columna-eride" style="min-width: 50px;">
            ERIDE
            <app-filtro filtroId="eride" [options]="erideOptions" [(showDropdown)]="showErideFilter" (apply)="onErideFilterApply($event)"
              (clear)="onErideFilterClear()"></app-filtro>
          </th>

          <th class="columna-apparel" style="min-width: 50px;">
            APPAREL
            <app-filtro filtroId="apparel" [options]="apparelOptions" [(showDropdown)]="showApparelFilter"
              (apply)="onApparelFilterApply($event)" (clear)="onApparelFilterClear()"></app-filtro>
          </th>

          <th class="columna-evac" style="min-width: 50px;">
            EVAC
            <app-filtro filtroId="evac" [options]="evacOptions" [(showDropdown)]="showEvacFilter" (apply)="onEvacFilterApply($event)"
              (clear)="onEvacFilterClear()"></app-filtro>
          </th>

          <th class="columna-categoria" style="min-width: 160px;">
            Categoría
            <app-filtro filtroId="categoria" [options]="categoriaOptions" [(showDropdown)]="showCategoriaFilter"
              (apply)="onCategoriaFilterApply($event)" (clear)="onCategoriaFilterClear()"></app-filtro>
          </th>

          <th class="columna-estado" style="min-width: 80px;">
            Estado
          </th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let factura of facturasPaginadas">
          <td>{{ factura.numero_factura }}</td>
          <td>{{ factura.referencia_interna }}</td>
          <td>{{ factura.nombre_producto }}</td>
          <td>{{ factura.contacto_referencia }}</td>
          <td>{{ factura.contacto_nombre }}</td>
          <td>{{ formatearFecha(factura.fecha_factura) }}</td>
          <td>{{ factura.precio_unitario | currency }}</td>
          <td>{{ factura.cantidad }}</td>
          <td>{{ factura.venta_total | currency }}</td>
          <td>{{ factura.marca }}</td>
          <td>{{ factura.subcategoria }}</td>
          <td>{{ factura.eride }}</td>
          <td>{{ factura.apparel }}</td>
          <td>{{ factura.evac }}</td>
          <td>{{ factura.categoria_producto }}</td>
          <td>{{ factura.estado_factura }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <div class="paginador" *ngIf="facturasFiltradas.length > elementosPorPagina">
    <button (click)="cambiarPagina(1)" [disabled]="paginaActual === 1">
      <i class="fas fa-angle-double-left"></i>
    </button>
    <button (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1">
      <i class="fas fa-angle-left"></i>
    </button>
    <span class="info-pagina">
      Página <strong>{{ paginaActual }}</strong> de <strong>{{ totalPaginas }}</strong>
    </span>
    <button (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas">
      <i class="fas fa-angle-right"></i>
    </button>
    <button (click)="cambiarPagina(totalPaginas)" [disabled]="paginaActual === totalPaginas">
      <i class="fas fa-angle-double-right"></i>
    </button>
  </div>
</div>